<!DOCTYPE html>
<!-- saved from url=(0079)http://127.0.0.1:3000/admin/battle_simulator/dragon_pvp_simulate#4_battler_play -->
<html lang="en-US" xml:lang="en-US" xmlns:fb="http://www.facebook.com/2008/fbml" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <script src="./DOA MOBILE Admin_files/jquery.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/jquery_ujs.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/jquery-ui-1.9.2.custom.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/toastr.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/moment.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/moment-timezone.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/moment-timezone-data.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/underscore.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/underscore.inflection.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/lodash-1.2.1.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/bootstrap.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/jstz.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/jquery.fixedtableheader.min.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/application.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/jquery-ui-timepicker-addon.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/common.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/generals.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/cities.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/dragons.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/redis_data.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/quests.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/player_regiments.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/player_current_npc_instance.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/views.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/jquery.suggest.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/d3.v3.js" type="text/javascript"></script>
    <script src="./DOA MOBILE Admin_files/nv.d3.js" type="text/javascript"></script>
    <title>DOA MOBILE Admin</title>
    <link href="./DOA MOBILE Admin_files/admin.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/jquery-ui-1.9.2.custom.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/formtastic.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/formtastic_changes.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/bootstrap.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/select2.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/toastr.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/admin_patch.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/application.css" media="all" rel="stylesheet" type="text/css">
    <link href="./DOA MOBILE Admin_files/nv.d3.css" media="all" rel="stylesheet" type="text/css">
    
  <style type="text/css"></style></head>
  <body class="admin_battle_simulator" id="admin_battle_simulator_dragon_pvp_simulate">
    <p>
      <button class="btn btn-primary" id="refresh_page" type="button">Refresh</button>
      <button class="btn btn-primary" id="back_prev_page" type="button">Back to Prev Page</button>
    </p>
    <div class="container" id="admin">
      <div class="row-fluid">
        <div class="span12">
        </div>
      </div>
      <div class="row-fluid" id="content">
        <div class="span12">
          <div class="container">
            <div class="row">
              <div class="span3" id="navbar">
                <ul class="nav nav-list affix-top" data-offset-top="35" data-spy="affix">
                  <li>
                    <a href="http://127.0.0.1:3000/admin/battle_simulator/dragon_pvp_simulate#1_total_sumary">
                      <i class="icon-chevron-right"></i>
                      1. Round times
                    </a>
                  </li>
                  <li>
                    <a href="http://127.0.0.1:3000/admin/battle_simulator/dragon_pvp_simulate#2_dragon_sumary">
                      <i class="icon-chevron-right"></i>
                      2. Troops and theirs quantity
                    </a>
                  </li>
                  <li>
                    <a href="http://127.0.0.1:3000/admin/battle_simulator/dragon_pvp_simulate#3_logs_info">
                      <i class="icon-chevron-right"></i>
                      3. Dragons and theirs level
                    </a>
                  </li>
                  <li>
                    <a href="./DOA MOBILE Admin_files/DOA MOBILE Admin.html">
                      <i class="icon-chevron-right"></i>
                      4. Researchs and theirs level
                    </a>
                  </li>
                </ul>
              </div>
              <div class="span9" data-offset="50" data-target="#navbar">
                <div class="row">
                  <div class="span12">
                    <h3 class="title" id="1_total_sumary">1. Total sumary</h3>
                    <div class="span12">
                      <table class="table table-striped table-hover table-bordered">
                        <thead>
                          <tr>
                            <th>Rounds</th>
                            <th>
                              <span class="label label-important">Winner</span>
                            </th>
                            <th>
                              <span class="label label-inverse">Attacker Died</span>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>
                              5
                            </td>
                            <td>
                              Attacker
                            </td>
                            <td>
                              []
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="row"></div>
                  <div class="span12">
                    <h3 class="title" id="2_dragon_sumary">2. Dragon sumary</h3>
                    <div class="span12">
                      <h4 class="title">Attacker</h4>
                      <table class="table table-striped table-hover table-bordered">
                        <thead>
                          <tr>
                            <th>slot</th>
                            <th>type</th>
                            <th>life</th>
                            <th>level</th>
                            <th>skilllevel</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                          </tr>
                          <tr>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                            <td>
                              
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="span12">
                    <h3 class="title" id="3_logs_info">3. Logs Info</h3>
                  </div>
                </div>
                <div class="row">
                  <div class="span12">
                    <h3 class="title" id="4_battler_play">4. Battle Play</h3>
                    <button class="btn-success" id="play_btn">Play</button>
                    <canvas class="hide" height="600" id="scene" width="1000"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      var battle_record = {"win":1,"replay_log":{"winner":1,"scene_name":null,"dragon_list":[{"slot":6,"life":254623,"type":2,"level":16},{"slot":4,"life":170231,"type":1,"level":13}],"round_list":[{"round":1,"force_status_list":[{"life":254623,"power":0,"slot":6,"max_life":254623},{"life":170231,"power":0,"slot":4,"max_life":170231}],"turn_list":[{"type":2,"source":4,"defend_list":[{"target":4,"numerica":54427,"after_attack_list":[]}],"rebound_turn":{},"after_attack_list":[{"target":4,"type":2,"args":1,"status":2}]},{"type":0,"source":6,"defend_list":[{"target":4,"numerica":78024,"after_attack_list":[{"target":4,"type":2,"args":2,"status":2}]}],"rebound_turn":{},"after_attack_list":[{"target":6,"type":2,"args":1,"status":2}]}]},{"round":2,"force_status_list":[{"life":254623,"power":1,"slot":6,"max_life":254623},{"life":92206,"power":2,"slot":4,"max_life":170231}],"turn_list":[{"type":2,"source":4,"defend_list":[{"target":4,"numerica":48206,"after_attack_list":[]}],"rebound_turn":{},"after_attack_list":[{"target":4,"type":2,"args":3,"status":2}]},{"type":0,"source":6,"defend_list":[{"target":4,"numerica":78753,"after_attack_list":[]}],"rebound_turn":{},"after_attack_list":[{"target":6,"type":2,"args":2,"status":2}]}]},{"round":3,"force_status_list":[{"life":254623,"power":2,"slot":6,"max_life":254623},{"life":61660,"power":3,"slot":4,"max_life":170231}],"turn_list":[{"type":3,"source":4,"defend_list":[{"target":4,"numerica":48206,"after_attack_list":[]}],"rebound_turn":{},"after_attack_list":[{"target":4,"type":2,"args":0,"status":2}]},{"type":0,"source":6,"defend_list":[{"target":4,"numerica":74378,"after_attack_list":[{"target":4,"type":2,"args":1,"status":2}]}],"rebound_turn":{},"after_attack_list":[{"target":6,"type":2,"args":3,"status":2}]}]},{"round":4,"force_status_list":[{"life":254623,"power":3,"slot":6,"max_life":254623},{"life":35489,"power":1,"slot":4,"max_life":170231}],"turn_list":[{"type":2,"source":4,"defend_list":[{"target":4,"numerica":49243,"after_attack_list":[]}],"rebound_turn":{},"after_attack_list":[{"target":4,"type":2,"args":2,"status":2}]},{"type":1,"source":6,"defend_list":[{"target":4,"numerica":69273,"after_attack_list":[{"target":4,"type":2,"args":3,"status":2}]}],"rebound_turn":{},"after_attack_list":[{"target":6,"type":2,"args":0,"status":2}]}]},{"round":5,"force_status_list":[{"life":254623,"power":0,"slot":6,"max_life":254623},{"life":15458,"power":3,"slot":4,"max_life":170231}],"turn_list":[{"type":3,"source":4,"defend_list":[{"target":4,"numerica":48206,"after_attack_list":[]}],"rebound_turn":{},"after_attack_list":[{"target":4,"type":2,"args":0,"status":2}]},{"type":0,"source":6,"defend_list":[{"target":4,"numerica":75836,"after_attack_list":[{"target":4,"type":1,"args":0,"status":1}]}],"rebound_turn":{},"after_attack_list":[{"target":6,"type":2,"args":1,"status":2}]}]}]},"dragon_died":[]};
      // inner variables
      var canvas, ctx;
      var backgroundImage;
      var iBgShiftX = 100;
      var dragonW = 75; // dragon width
      var dragonH = 70; // dragon height
      var iSprPos = 0; // initial sprite frame
      var iSprDir = 4; // initial dragon direction
      var dragonSound; // dragon sound
      var wingsSound; // wings sound
      var dragons_list = [];
      var dragons_list_map ={}
      var currRound = 1;
      var renderTexts = [];
      var fireball_list = [];
      var heal_list = [];
      var is_running = false;
      
      var Config = {
          DragonMargin: 30,
          TeamMargin:100,
          StartX:400,
          StartY:100,
      }
      
      
      var TO_RADIANS = Math.PI/180; 
      function drawRotatedImage(image, x, y, angle) { 
          // save the current co-ordinate system 
          // before we screw with it
          ctx.save(); 
          // move to the middle of where we want to draw our image
          ctx.translate(x, y);
          // rotate around that point, converting our 
          // angle from degrees to radians 
          ctx.rotate(angle * TO_RADIANS);
          // draw it up and to the left by half the width
          // and height of the image 
          ctx.drawImage(image, -(image.width/2), -(image.height/2));
          // and restore the co-ords to how they were when we began
          ctx.restore(); 
      }
      // -------------------------------------------------------------
      function Heal(x,y,healing)
      {
          this.x = x
          this.y = y
          this.alive = true;
          this.healing = healing;
      }
      Heal.prototype = {
          show:function(){
              ctx.drawImage(Heal.image, this.x, this.y,25,25);
              ctx.font = "30px Arial";
              ctx.fillStyle = 'green';
              ctx.fillText(this.healing,this.x,this.y);
          }
      }
      function Dragon( slot, type, life, max_life, level)
      {
          var xy = Dragon.find_pos_by_slot(slot)
          this.x =  xy.x
          this.y =  xy.y 
          
          this.origin_x = this.x;
          this.origin_y = this.y;
      
      
          this.w = 75
          this.h = 70
          this.power = 0
          this.type = type
          this.life = life
          this.direction = (slot >5)?6:2
          this.origin_dir = this.direction
          this.slot = slot
          this.max_life = max_life
          this.level = level
          this.buffs = {}//[0,1]
      }
      
      Dragon.find_pos_by_slot = function(slot)
      {
          var dest_x =  Config.StartX + parseInt(slot % 3 ) * (dragonW  + Config.DragonMargin)  
          var dest_y =  Config.StartY + parseInt(slot / 3) * (dragonH  + Config.DragonMargin)  
          if(slot >5)
          {
              dest_y += Config.TeamMargin
              dest_y -= dragonH/2
          }
          else{
      
              dest_y += dragonH/2
          }
          return {x:dest_x,y:dest_y};
      } 
      
      Dragon.types_string = ["Greate","Water","Night","Earth","Fire"]
      
      
      Dragon.prototype = {
          show:function(ctx,iSprPos)
          {
              var dragon = this;
      
              //if life is zero
              if(this.life == 0)
              {
                  iSprPos = 0
              }
      
              //render name
              ctx.font = "12px Arial";
              ctx.fillStyle = 'white';
      
              ctx.fillText(Dragon.types_string[dragon.type],dragon.x + 10 ,dragon.y - 23);
          
      
              ctx.font = "12px Arial";
              ctx.fillStyle = 'white';
              ctx.fillText("slot "+ dragon.slot,dragon.x-dragon.w/2 + 8,dragon.y-dragon.h/2- 20);
              ctx.drawImage(Dragon.image, iSprPos*dragon.w, dragon.direction *dragon.h, dragon.w, dragon.h, dragon.x - dragon.w/2, dragon.y - dragon.h/2, dragon.w, dragon.h);
          
      
              if(this.life == 0)
              {
                  ctx.beginPath()
                  ctx.lineWidth = 2
                  ctx.strokeStyle = "black"
                  ctx.moveTo(dragon.x - dragon.w/2,dragon.y-dragon.h/2)
                  ctx.lineTo(dragon.x + dragon.w/2,dragon.y+dragon.h/2)
                  ctx.stroke();
                  ctx.moveTo(dragon.x + dragon.w/2,dragon.y-dragon.h/2)
                  ctx.lineTo(dragon.x - dragon.w/2,dragon.y+dragon.h/2)
                  ctx.stroke();
                  ctx.closePath();
      
              }
      
      
              //render buffer
      
              // Red rectangle
              var colors = ["red","blue"]
              for(var i in dragon.buffs)
              {   
                  var type = i;
                  ctx.beginPath();
                  ctx.lineWidth="2";
                  ctx.strokeStyle= colors[type];
                  type *= 3
                  ctx.rect(dragon.x-dragon.w/2-type,dragon.y-dragon.h/2-type,dragon.w + 2*type, dragon.h + 2*type ); 
                  ctx.stroke();
              }
      
              var ratio = 0;
              //render life
              ctx.strokeStyle = "white"
              ctx.strokeRect(dragon.x - dragon.w/2,dragon.y - dragon.h/2 - 16,dragon.w,3);
              ctx.fillStyle = "rgb(255, 0,0)";
              ratio = dragon.life/dragon.max_life
              ctx.fillRect(dragon.x - dragon.w/2,dragon.y - dragon.h/2 - 16,dragon.w*ratio,3);
      
              //render power
              ctx.strokeStyle = "white"
              ctx.strokeRect(dragon.x - dragon.w/2,dragon.y - dragon.h/2 - 10,dragon.w,3);
              ctx.fillStyle = "rgb(0,255,0)";
              ratio = dragon.power/3
              ctx.fillRect(dragon.x - dragon.w/2,dragon.y - dragon.h/2 - 10,dragon.w * ratio,3);
      
          },
          
          update_status:function(after_attack_list)
          {
              var dragon = this;
              for(var i in after_attack_list)
              {
                  var status = after_attack_list[i]
                  if( status.target == dragon.slot )
                  {
      
                      if(status.type == 2 ) //power
                          dragon.power = status.args;
                      else if(status.type == 0) //buffer
                      {
                          if(status.status == 0) //add
                          {
                              dragon.buffs[status.args] = 1
                          }
                          else if(status.status == 1)//delete
                          {
                              delete dragon.buffs[status.args]
                              //show rebound damage
                              if(status.args == 0)
                              {
                                  var rebound_turn = round_list[currRound-1].turn_list[current_turn].rebound_turn;
                                  dragons_list_map[rebound_turn.target].take_rebound_damage(rebound_turn.numerica);
                              }
                          }
      
                      }
      
                  }
      
              }
      
          },
          reset:function()
          {
      
              this.direction = this.origin_dir;
              this.x = this.origin_x;
              this.y = this.origin_y;
          },
          get_heal:function(target,callback)
          {
              var dragon = this;
              var heal_obj = new Heal(this.x + this.w/2,this.y-+ this.h/2,"+" + target.numerica);
              heal_list.push(heal_obj);
              setTimeout(function(){
                  heal_obj.alive = false
                  dragon.life += target.numerica;
                  dragon.update_status(target.after_attack_list)
      
                  if(dragon.life > dragon.max_life)
                      dragon.life = dragon.max_life;
                  if(callback)
                      callback();
      
              },800);
          },
      
          take_damage:function(damage,callback)
          {
              var dragon = this;
              renderTexts.push(["30px Arial","#FFCC33","-" + damage,this.x,this.y])
      
              setTimeout(function(){
                  renderTexts.pop();
                  dragon.life -= damage;
                  if(dragon.life < 0)
                      dragon.life = 0;
                  if(callback)
                      callback();
              },500);
      
          },
          take_rebound_damage:function(damage,callback)
          {
              this.reset();
              var dragon = this;
              renderTexts.push(["30px Arial","#00af33","Rebound:-" + damage,this.x,this.y - 10])
      
              setTimeout(function(){
                  renderTexts.pop();
                  dragon.life -= damage;
                  if(dragon.life < 0)
                      dragon.life = 0;
                  if(callback)
                      callback();
              },500);
          },
          play_magic:function(callback,args)
          {
              var changes_up = [3,2,1,2]
              var changes_down = [5,6,7,5]
              var index = 0
              var dragon = this;
      
              var timer = setInterval(function(){
                  if(dragon.origin_dir == 2)
                      dragon.direction = changes_up[index];
                  else
                      dragon.direction = changes_down[index];
      
                  index++;
                  if(index > changes_up.length)
                  {
                      clearInterval(timer);
                      dragon.reset();
                      if(callback != undefined)
                          callback(args);
                  }
              },200);
      
          },
          add_buff:function(callback,after_attack_list)
          {
              var dragon = this;
              dragon.play_magic(function(){
                  dragon.update_status(after_attack_list);
                  if(callback != undefined)
                      callback();
              });
      
          },
          fire_magic:function(targets,callback) //[slot,damage]
          {
      
              for(var i in targets)
              {
                  var target = targets[i];
                  var fire = new Fire(this.x,this.y,0)
                  fireball_list.push(fire);
                  target_dragon = dragons_list_map[target.target]
                  if(i == (targets.length - 1) )
                      Fire.play_towards_animation( fire,target_dragon,target,callback);
                  else
                      Fire.play_towards_animation( fire,target_dragon,target);
              }
          },
          heal:function(targets,after_attack_list,callback)
          {
              var dragon = this;
              var callback_func = function(){
                  dragon.update_status(after_attack_list)
                  if(callback != undefined)
                      callback();
              }   
      
              dragon.play_magic(function(){
                  for(var i in targets)
                  {
                      var target = targets[i];
                      target_dragon = dragons_list_map[target.target]
                      if(i == (targets.length - 1) )
                      {
                          target_dragon.get_heal(target,callback_func);
                      }
                      else
                      {
                          target_dragon.get_heal(target);
                      }
                  }
              });
          },
          attack:function(type,targets,status_list,callback)
          {
              var dragon = this;
              var normal_attack_func = function(target){
                  var dst = Dragon.find_pos_by_slot(target.target);
                  var target_dragon = dragons_list_map[target.target];
                  var dest_x =dst.x;
                  var dest_y = dst.y;
      
                  var times = 10;
                  var delta_x = (dest_x - dragon.x) /times;
                  var delta_y = (dest_y - dragon.y) /times;
      
                  if(dragon.direction == 2) // down
                  {
                      if(delta_x < 0)
                          dragon.direction = 3;
                      else if(delta_x > 0)
                          dragon.direction = 1;
      
                  }
                  else
                  {
                      if(delta_x < 0)
                          dragon.direction = 5;
                      else if(delta_x > 0)
                          dragon.direction = 7;
                  }
      
                  var timer = setInterval(function(){
                      dragon.x += delta_x
                      dragon.y += delta_y
      
                      times--;
      
                      if(times == 0)
                      {
                          clearInterval(timer);   
                          target_dragon.take_damage(target.numerica,function(){
                              target_dragon.update_status(target.after_attack_list)
                              dragon.reset();
                              dragon.update_status(status_list);
                              if(callback)
                                  callback();
                          })
                      }
                  }, 50); // loo
      
              }
      
              var magic_attack_func = function(targets){
      
                  dragon.play_magic(function(){
                      dragon.fire_magic(targets,callback);
                  })
      
              }
      
              if(type == 0)
                      normal_attack_func(targets[0]);
              else{
                  magic_attack_func(targets);
              }
      
      
          }
      }
      
      
      
      
      function Fire(x,y,rotate)
      {
      
          this.x = x;
          this.y = y;
          this.rotate = rotate;
          this.alive = 1;
      }
      
      
      Fire.play_towards_animation = function(src,target_dragon,target,callback)
      {
              var dst =  Dragon.find_pos_by_slot(target_dragon.slot);
      
              var times = 10;
              var delta_x = (dst.x - src.x) /times;
              var delta_y = (dst.y - src.y) /times;
              var rotate;
              if(delta_x == 0)
                  rotate = 0
              else    
                  rotate = delta_y / delta_x  / TO_RADIANS;
              src.rotate = rotate;
              var timer = setInterval(function(){
                  src.x += delta_x
                  src.y += delta_y
                  times--;
                  if(times == 0)
                  {
                      clearInterval(timer);   
                      setTimeout(function(){
                          src.alive =false;
                          target_dragon.take_damage(target.numerica,function(){
                              target_dragon.update_status(target.after_attack_list);
                              if(callback)
                                  callback();
                          })
                      },100);
                      
                  }
              }, 50); // loo
      
      }
      
      Fire.prototype = {
          show:function(ctx)
          {
              drawRotatedImage(Fire.image,this.x,this.y,this.rotate);
          }
      }
      
      // draw functions :
      function clear() { // clear canvas function
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      }
      
      function drawScene() { // main drawScene function
          clear(); // clear canvas
      
          // draw background
         // iBgShiftX -= 4;
          if (iBgShiftX <= 0) {
              iBgShiftX = 1045;
          }
          ctx.drawImage(backgroundImage, 0 + iBgShiftX, 0, 1000, 940, 0, 0, 1000, 600);
      
          // update sprite positions
          iSprPos++;
          if (iSprPos >= 9) {
              iSprPos = 0;
          }
      
      
          for(var i in dragons_list)
          {
              dragon = dragons_list[i];
              dragon.show(ctx,iSprPos)
          }
      
      
          //draw render texts
          for(var i in renderTexts)
          {
              text_array = renderTexts[i];
              ctx.font = text_array[0];
              ctx.fillStyle = text_array[1];
              ctx.fillText(text_array[2],text_array[3],text_array[4]);
      
          }
      
           for(var i in fireball_list)
          {
              fireball = fireball_list[i];
              if(fireball.alive)
                  fireball.show(ctx);
          }
      
      
           for(var i in heal_list)
          {
              heal = heal_list[i];
              if(heal.alive)
                  heal.show(ctx);
          }
      
      
      }
      
      function InitDragons()
      {
          for(var i in battle_record.replay_log.dragon_list)
          {
              var obj = battle_record.replay_log.dragon_list[i];
              dragon = new Dragon( obj.slot, obj.type, obj.life, obj.life, obj.life.level)
              dragons_list.push(dragon);
              dragons_list_map[dragon.slot] = dragon
      
          }
      
      }
      
      var round_list ;
      var current_turn = 0;
      function PlayTurn()
      {
          var turn = round_list[currRound-1].turn_list[current_turn];
      
          var after_animation = function(){
              //handle after_attack_list
              //after_attack_list
              current_turn++;
              if(current_turn >= round_list[currRound-1].turn_list.length )
              {
                  PlayRound()
              }
              else{
                  PlayTurn();
              }
          }
      
          var targets = turn.defend_list;
          var after_attack_list = turn.after_attack_list;
          switch(turn.type)
          {
              case 0: //normal attack
                  dragons_list_map[turn.source].attack(turn.type,targets,after_attack_list,after_animation);
                  break;
              case 1: //TYPE_ATTACK_MAGIC
                  dragons_list_map[turn.source].attack(turn.type,targets,after_attack_list,after_animation);
                  break;
              case 2: //TYPE_HEAL
                  dragons_list_map[turn.source].heal(targets,after_attack_list,after_animation);
                  break;
              case 3: //TYPE_MAGIC_HEAL
                  dragons_list_map[turn.source].heal(targets,after_attack_list,after_animation);
                  break;
              case 4: //TYPE_MAGIC_BUFF
                  dragons_list_map[turn.source].add_buff(after_animation,after_attack_list);
              default:
                  break;
          }
      
      
      
      }
      
      
      function PlayRound()
      {
          currRound += 1
      
          if(currRound <= round_list.length)
          {
              var current_round = round_list[currRound-1];
      
              //force status
              var map = {}
              for(var i in current_round.force_status_list)
              {
                  var obj = current_round.force_status_list[i];
                  map[obj.slot] = obj
              }   
              for(var i in dragons_list)
              {
                  var dragon = dragons_list[i];
                  var obj = map[dragon.slot];
                  dragon.power = obj.power
                  dragon.life = obj.life
              }   
      
              //play turn
              current_turn = 0
              PlayTurn();
          }
      }
      
      
      function Play()
      {
          
      
      
          currRound = 0
      
          round_list = battle_record.replay_log.round_list;
      
      
          PlayRound();
      
      
      
      
      }
      // -------------------------------------------------------------
      
      // initialization
      $(function(){
          canvas = document.getElementById('scene');
          ctx = canvas.getContext('2d');
          var width = canvas.width;
          var height = canvas.height;
          // load background image
          backgroundImage = new Image();
          backgroundImage.src = '/assets/images/dragon_pvp/hell.jpg';
          backgroundImage.onload = function() {
          }
          backgroundImage.onerror = function() {
              console.log('Error loading the background image.');
          }
      
          // initialization of dragon
          var oDragonImage = new Image();
          oDragonImage.src = '/assets/images/dragon_pvp/dragon.gif';
          oDragonImage.onload = function() {
          }
          Dragon.image = oDragonImage;
          var healImage = new Image();
          healImage.src = "/assets/images/dragon_pvp/heal.jpg";
          healImage.onload = function(){}
          Heal.image = healImage;
          var fireImage = new Image();
          fireImage.src = '/assets/images/dragon_pvp/fireball.png'
          fireImage.onload = function(){}
          Fire.image = fireImage;
          setInterval(drawScene, 50); // loop drawScene
      
      
          InitDragons();
      
      
          $('#play_btn').click(function(){
             $('#play_btn').attr("disabled",true)
              if(!is_running)
              {
                  $('#scene').show();
                  is_running = true;
                  Play();
              }
          })
      
      
          // $('#replay_btn').click(function(){
          //     if(!is_running)
          //     {
          //         is_running = true;
          //         Play();
          //     }
          // })
      
      });
    </script>
    <script>
      $(document).ready(function() {
        if (C.views.admin_battle_simulator_dragon_pvp_simulate) { C.views.admin_battle_simulator_dragon_pvp_simulate(); }
        if ("admin_battle_simulator_dragon_pvp_simulate" == "admin_sessions_new") {
          $("#refresh_page").hide();
          $("#back_prev_page").hide();
        }
      
        $("#refresh_page").click(function(event){
          event.preventDefault();
          window.location.reload();
        });
        $("#back_prev_page").click(function(event){
          event.preventDefault();
          history.back(1);
        });
      });
    </script>
  

</body></html>